## 嵌入式微处理器体系结构

### 冯诺依曼结构

- 定义：由CPU和存储器组成，程序计数器（PC）是CPU内部指示指令和数据的存储位置的寄存器

- 过程：CPU通过对程序计数器（PC）提供的地址信息，对存储器进行寻址，找到所需的指令或数据，然后对指令进行译码，最后执行指令规定的操作。

  ![冯诺依曼](/img/冯诺依曼.png)

> 采用冯诺依曼体系结构的CPU和微控制器有：英特尔的8086及其他CPU、ARM的ARM7、MIPS的MIPS处理器

### 哈佛结构

- 定义：由CPU、程序存储器和数据存储器组成的一种并行结构。其中，程序存储器和数据存储器是两个相互独立的存储器

- 特点：将程序和数据存储在不同的存储器中，每个存储器独立编址、独立访问；与两个存储器对应的是4套总线，即程序的数据总线和地址总线、数据的数据总线和地址总线。从而提供较大的存储器带宽，获得更高的数字处理性能。

  ![哈佛结构](/img/哈佛结构.png)

> 采用哈佛结构的CPU和微控制器有：除了所有的DSP处理器，还有摩托罗拉的MC68、Zilog的Z8、ATMEL的AVR、ARM的ARM9、ARM10和ARM11等

### 复杂指令集计算机（Complex Instruction Set Computer, CISC）

- 定义：包括一个复杂数据通路和一个微程序控制器。微程序控制器由一个微程序存储器、微程序计数器（MicroPC）和地址选择逻辑组成。

> 在微程序存储器中的每一个字都表示一个控制字，包含一个时钟周期内所有数据通路控制信号的值

- 取指操作：①当从内存中取出一条指令时候，首先保存到指令寄存器；②然后地址选择逻辑确定微程序控制器中的控制字顺序起始地址；③把该地址放入到微程序计数器后，就从微程序内存中找到相应的控制字；④利用数据通路把数据从一个寄存器传送到另一个寄存器中，完成取指操作。

  > 由于微程序计数器（MicroPC）是并发递增指向下一个控制字，因此整个指令序列中的每个控制器会递归步骤，直到执行最后一个控制字时，就从内存中取出一条新的指令。

  ![CISC控制计算机](/img/CISC控制计算机.png)

- 优点：可以有效减少编译代码中指令的数目，使取指令操作所需要的内存访问数量达到最小化。由于CISC的指令集包含了类似程序设计语言中的复杂指令，减少了程序设计语言和机器语言之间的差别，从而达到简化编译器结构

- 缺点：不适合高效处理器

- 存在的问题：①2/8规律，即20%简单指令经常使用，80%指令很少使用；②超大规模集成电路（Very Large Scale Integration, VLSI）制造工艺要求CPU控制逻辑的规整性难以匹配（VLSI工艺发展迅速，摩尔定律）；③通过增强复杂指令的功能，使得指令执行时间加长，简化了软件但是增加了硬件的复杂程度。（软硬件功能应该划分合适）

### 精简指令集计算机（Reduced Instrution Set Computer, RISC）

- 定义：由一个大的寄存器文件和一个算术逻辑单元（Arithmetic and Logic Unit, ALU）组成，其中，寄存器文件保存了程序计算中所有的操作数和结果。

- 执行过程：①首先，指令管道将指令放到指令寄存器中；②然后将该指令解码并存寄存器中取得操作数；③最后，要么在ALU中执行所需操作，要么从数据缓存里面读/写数据。

  > 每个指令仅占用3个时钟周期，意味着指令流水线可能短小且高效。

  ![RISC控制](/img/RISC控制.png)

- 优点：简化数据通路设计和控制单元，从而获得更高的性能

- 缺点：由于指令数目的减少，编译器需要一系列的RISC指令完成复杂的动作。

- 特点：①优先选取使用频率最高的一些指令，以及一些很有用但不复杂的指令，避免使用复杂指令；②指令之间各字段的划分比较一致，各字段的功能也比较规整；③只有Load/Store指令能够访问寄存器，算术逻辑运算指令的操作数都在通用寄存器中存取，其他指令的操作都在寄存器之间进行；④大部分指令都在≤一个机器周期内完成；⑤以硬布线控制逻辑为主，不用或少用微码控制；⑥一般用高级程序语言编程和优化，减少程序编译执行时间。

### 计算机执行程序所需时间

- P = I * CPI * T（I是高级程序语言编译后在机器上运行的指令数，CPI为执行每条指令所需的平均周期数，T是每个机器周期的时间）

  ![CISC和RISC的比较](/img/CISC和RISC的比较.png)

- 小结：尽管RISC是在CISC的基础上优化而来，但仍旧不能认为RISC可以取代CISC。两者各有优势，现代的CPU的外围往往是CISC，内部则加入了RISC的特性。

### 流水线技术

- 定义：将一条指令分解成一连串执行的子过程。在CPU中把一条指令的串行执行子过程变为若干条指令的子过程在CPU中**重叠**执行，这就是**指令流水线的思想**

  > 如果能做到每条指令均分解为m个子过程，且每个子过程的执行时间都一样，则利用此流水线可将一条指令的执行时间由原来的T缩短为T/m

- 指令的执行过程：取指令、分析指令、执行指令

- 执行指令的两种方式：①顺序执行：即前一段指令执行完毕后才开始读取后续指令，这种方式控制比较简单，但时间安排上不能充分利用；②重叠处理，在一次重叠处理时，将指令的执行过程分为**分析**和**执行**两个子过程，当第I条指令在分析部件完毕后，就进入执行部件进行操作，此时分析部件是空闲状态，则第I+1条指令就进入分析部件分析，使其与第I条指令在执行部件中同时进行（两条指令在相同的时间上重叠）

  ![一次重叠处理](/img/一次重叠处理.png)

- 特点：①流水线技术可分为若干联系的子过程；②实现子过程的功能的时间尽可能相等；③形成流水处理，需要一段准备时间；③指令不能顺序执行时，会使流水线过程中断，再形成流水线需要时间。

- 分类：①按功能：单功能流水线和多功能流水线

  			②按连接方式：静态流水线和动态流水线

  				③按数据：标量流水线和向量流水线

- 主要指标：①吞吐率P，指单位时间里流水线处理机流出的指标。对指令而言就是单位时间内执行的指令数；

  > 如果流水线所处理的子过程时间不一样，则吞吐率P是最长子过程的倒数 = 1/max｛Δt1,Δt2,...,tm｝

- ②建立时间，流水线开始工作，需要经过一定时间才能到达最大吞吐率，这就是建立时间。

  >  若m个子过程所用时间一样，均为t0，则建立时间T0 = mΔt0



