## 第一章  嵌入式系统基础知识

### 嵌入式系统的定义

- 嵌入式系统定义：以应用为中心，以计算机技术为基础，软硬件可裁剪，适用应用系统对功能、可靠性、成本、体积、功耗严格要求的专用计算机系统。

> 具有实时发展历史：无操作系统阶段、简单操作系统阶段、实时操作系统阶段、面向Internet阶段

### 嵌入式系统的发展概述

- 片上系统（System On Chip, SOC）：指在单芯片上集成数字信号处理器、微控制器、存储器、数据转换器、接口电路等电路模块，可以直接实现信号采集、转换、存储、处理等功能，其中知识产权核（IP Core）设计是SOC设计的基础。
- 知识产权核（IP Core）：指具有知识产权的、功能具体、接口规范、可在多个集成电路设计中重复使用的功能模块，是实现系统芯片（SOC）的基本构件。
- 三种不同程度的设计：行为、结构、物理
- 三种对应描述的功能行为：软核、固核（Firm IP Core）、硬核（Hard IP Core）
- 软核：采用**硬件描述语言**（Hardware Description Language, HDL）文本形式呈现给用户。缺点是缺乏对时序、面积和功耗的可预见性，且IP软核以**源代码**的形式分发，它的知识产权不易于保护。
- 硬核：采用**电路物理结构掩膜版图**和**全套工艺文件**的形式呈现。
- 固核：介于软核和硬核之间，一般以**门级电路网表**的形式提供给用户。

### 嵌入式系统的组成

- 嵌入式系统的组成：一般由**嵌入式计算机系统**和**执行装置**组成。嵌入式计算机系统是整个嵌入式系统的核心，由硬件层、中间层、系统软件层和应用软件层组成；执行装置也称为被控对象，它可以接受嵌入式计算机系统发出的控制命令、执行规定的操作或任务。

  ![嵌入式系统组成](/img/嵌入式系统组成.png)

- **硬件层**：包括嵌入式微处理器、存储器（SDRAM、ROM、Flash等）、通用设备接口和I/O接口（A/D、D/A、I/O等），其中操作系统和应用程序可以固化在ROM中。

  - 嵌入式微处理器：嵌入式微处理器是硬件层的核心。它的体系结构可以采用冯·诺依曼体系结构或哈佛体系结构；指令系统可采用精简指令系统（Reduce Instruction Set Computer, RISC）和复杂指令系统（Complex Instruction Set Computer, CISC）。

  - 存储器：用来存放和执行代码。包含Cache、主存和辅存。

    ![存储器结构](/img/存储器结构.png)

    - Cache：是一种容量小、速度快的存储器阵列，它位于主存和微处理器内核之间，存放的是最近一段时间内使用得最多的程序代码和数据。Cache的主要目标是减小存储器（如主存和辅存）给微处理器内核造成的访问速度瓶颈，使处理速度更快、实时性更强。

      > Cache可分为数据Cache、指令Cache、混合Cache

      

  - 主存：指嵌入式微处理器能够直接访问的寄存器，用来存放系统和用户程序及数据。

    > ROM类：NOR Flash、EPROM和PROM等
    >
    > RAM类：SRAM、DRAM和SDRAM等
    >
    > 其中NOR Flash是可擦写次数更多、存储速度快、存储容量大、价格便宜等优点，在嵌入式领域得到了广泛应用。

    

  - 辅存：用来存储大数据量的程序代码或信息，它的容量大、但读取速度比主存更慢，用来长期保存用户的信息。

    > 硬盘、NAND Flash、TF卡、MMC和SD卡等

    

- 通用设备接口和I/O接口：嵌入式系统与外界交互需要一定形式的通用设备接口，如A/D、D/A、I/O等，外设通过和片外其他设备或传感器的连接来实现微处理器的I/O功能。

  > 常用的通用设备接口有：A/D、D/A，I/O接口有RS-232接口（串行通信接口）、Ethernet（以太网接口）、USB（通用串行总线接口）、音频接口、VGA视频接口、I2C（现场总线）、SPI（串行外围设备接口）和IrDA（红外线接口）等

- **中间层**：硬件层和软件层之间为中间层，也称为硬件抽象层（Hardware Abstract Layer, HAL）或板级支持包（Board Support Package, BSP），它将上层软件和底层硬件分离开来，使系统的底层驱动程序与硬件无关，上层软件开发人员无需关注底层硬件的具体情况，根据BSP层提供的接口即可进行开发。

  - BSP的特点：硬件相关性、操作系统相关性
  - 设计一个完整的BSP需要完成两部分工作：硬件初始化和BSP功能、设计硬件相关的设备驱动

- 嵌入式系统系统初始化的环节：片级初始化、板级初始化、系统级初始化

- **系统软件层**：由实时多任务操作系统（Real-time Operation System, RTOS）、文件系统、图形用户接口（Graphic User Internet, GUI）、网络系统及通用组件模块组成。RTOS是嵌入式应用软件的基础和开发平台。

- 嵌入式操作系统（Embedded Operating System, EOS）相对于一般的操作系统而言，具备一般的操作系统的基本功能，如任务调度、同步机制、中断处理、文件处理外，还具备以下特点：

  - 可裁剪性
  - 强实时性
  - 统一接口
  - 操作方便，友好的图形界面（GUI）
  - 强大的网络通信功能
  - 强稳定性，弱交互性
  - 固化代码（一般固化在ROM中）
  - 良好的移植性

- 嵌入式文件系统的特点：比较简单，主要提供文件存储、检错和更新功能，一般不提供保护和加密等安全机制。它以系统调用和命令方式提供文件的各种操作。

  - 兼容性
  - 实时文件系统
  - 可裁剪和可配置
  - 支持多种存储设备

- 嵌入式系统图形用户接口（GUI）：轻型、占用资源少、高性能、高可靠性，便于移植和配置的特点。

  - 针对特定的图形设备输出接口，自行开发相应的功能函数
  - 购买针对特定嵌入式的图形中间软件包
  - 采用源码开放的嵌入式GUI系统
  - 使用独立软件开发商提供的嵌入式GUI产品

- **应用软件层**：由基于实时系统开发的应用程序组成，用来实现被控对象的控制功能。

### 实时系统

- 通用系统与实时系统的区别：前者一般追求的是系统的平均响应时间和用户使用系统的方便，而后者主要考虑的是系统在最坏情况下的系统行为。

- 实时系统（RTOS）的定义：实时系统能够在指定或者确定的时间内完成系统功能和对外部或内部、同步或异步时间做出响应的系统。其正确性不仅依赖于系统计算机的逻辑结果，还依赖于产生这个结果的时间。

  > 实时系统应该有在事先定义的时间范围内识别和处理离散事件的能力。

- 特点：时间约束性（包括时间、资源、执行顺序和性能）、可预测性、可靠性、与外部环境的交互作用性

- 新特点：多种任务类型、约束的复杂性、短暂超载（负载）

### 实时系统调度

> 在非实时系统中，调度的主要目的是缩短系统平均响应时间、提高系统资源利用率或优化某一项指标；
>
> 而在实时系统中，尽可能地保证每个任务满足它们的时间约束，及时对外部请求做出响应。

- 抢占式调度：指优先级驱动的调度。每个任务都有优先级，任何时候具有最高优先级且已启动的任务先执行。

  - 优点：实时性好，反应快，调度算法相对简单，可优先保证高优先级任务的时间约束

  - 缺点：切换上下文多

- 非抢占式调度：指不允许任务在执行期间被中断，任务一旦占用处理器就必须执行完毕或自愿放弃

  - 优点：切换上下文少

  - 缺点：处理器有效资源利用率低，可调度性不好

- 静态表驱动策略：是一种离线调度策略，指在**系统运行前**根据各任务的时间约束及关联关系，采用某种搜索策略生成一张运行时刻表。（运行时刻表一旦生成就不发生变化了）

- 优先级驱动策略：指按照任务优先级的高低确定任务的执行顺序。

> 静态优先级调度也被称为固定优先级分配，是指任务优先级分配好后，在任务运行过程中，优先级不会发生改变；动态优先级调度是指任务的优先级可以随时间或系统状态变化而发生变化。

- 实时系统的分类：

  - 强实时（Hard Real-Time）系统：航空航天、军事、核工业等领域

    > 反例：飞机失事，重大生命财产安全事故

  - 弱实时（Soft Real-Time）系统：视频点播（Video-On-Demand, VOD）系统、信息采集与检索系统

- 实时任务的分类：周期任务、偶发任务、非周期任务

> 在实时系统中，如果一个任务未能在截止期限完成的话，则称为任务超时

- 根据是否允许任务超时，以及超时后对系统带来的影响，任务可分为以下四类：
- 强实时任务：必须在规定时间完成，不允许任何时间超时。（否则将会带来重大生命财产安全损失~
- 准实时任务：指允许任务超时，若超时，则该任务的计算结果没有任何意义
- 弱实时任务：允许任务超时，若超时，则该任务的计算结果仍有一定意义。（但随着时间的增长意义会逐渐减弱）
- 弱—强实时任务：允许一定比例的任务超时，这些超时任务的分布满足一定的规律性，称为超时约束分布；若不满足分布，则会造成系统的动态失效

> 实时系统一般的例子有，小而快速的内核（μC/OS）；通用操作系统实时扩展，如RT-Linux；基于组件的内核，如OS-Kit、Coyote、2K、MMLite等；基于QoS的内核等。

- 实时系统由三类任务模型组成：数据采集管理任务、数据处理任务、执行机构管理任务
  - 流程：首先数据采集任务实现传感器数据的采集，再由数据处理任务处理数据，最后把加工后的数据送到执行机构管理任务执行。